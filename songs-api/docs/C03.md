# DO2526-C03: Logging, Volúmenes y Operaciones

Este hito se centra en la mejora de la observabilidad (Logging), la gestión avanzada de configuración (Environments) y el despliegue ágil.

## Requisitos y Estado

Se ha realizado un microtest de los conceptos y tecnologías explicadas en C02/C03. A continuación se detalla cada requisito y su estado de implementación:

- [x] **1. Añadir soporte de logging usando el módulo Winston**: 
  *Descripción*: Integrar el módulo Winston (ya incluido con OAS-Tools) para no usar solo salida por consola, sino escribir en fichero de logs.
  *Estado*: Implementado. Se generan archivos en `logs/combined.log` y `logs/error.log`.

- [x] **2. Configurar el contenedor de la API para almacenar logs en volumen**: 
  *Descripción*: Configurar el contenedor para persistir los ficheros de logs.
  *Estado*: Configurado volumen `api-logs`.

- [x] **3. Configurar MongoDB para almacenar logs y datos en volúmenes distintos**: 
  *Descripción*: Configurar docker-compose para que MongoDB guarde logs en un volumen y datos en otro distinto.
  *Estado*: Separados volúmenes `mongo-logs` y `mongo-data`.

- [x] **4. Posibilitar modificación del puerto API vía variables de entorno**: 
  *Descripción*: Usar variables de entorno para definir el puerto de escucha.
  *Estado*: Implementado mediante `PORT` y mapeo en `API_PORT`.

- [x] **5. Sistema de despliegue ágil (Dev + Prod)**: 
  *Descripción*: Usar docker-compose para desplegar ágilmente la aplicación completa (API + BD) en entornos de producción y desarrollo, capaces de coexistir en el mismo host.
  *Estado*: Archivos `.env.dev` y `.env.prod` creados para despliegue simultáneo en puertos 8080 y 8081.

- [x] **6. Subir código al repositorio DO2526-usuario**: 
  *Descripción*: Subir todo el código desarrollado al repositorio.
  *Estado*: Código actualizado en el repositorio.

- [x] **7. Subir imagen a Docker Hub (DO2526-C03)**: 
  *Descripción*: Subir la última versión de la imagen etiquetada como `DO2526-C03` usando la plantilla `usuario/tipoDeDatoAPI`.
  *Estado*: Imagen `danvelcam621/songs-api:DO2526-C03` publicada.

### Extras (Opcionales)
- [x] **1. Incluir tercer contenedor con Interfaz de Usuario (UI)**: 
  *Descripción*: Proporcionar una interfaz con la misma funcionalidad que la desarrollada en Fundamentos de Ingeniería Cloud (operaciones CRUD). (0,25 puntos)
  *Estado*: **Implementado**. Desarrollado con **React + Vite + TailwindCSS**.
    - Servicio `songs-web` añadido a `docker-compose`.
    - **Dev**: Puerto 5173 (Hot-reload).
    - **Prod**: Puerto 8082 (Nginx).

- [x] **2. Utilizar un proxy inverso**: 
  *Descripción*: Usar un proxy (ej. nginx-proxy) para desplegar entornos completos de desarrollo y producción en el mismo host de forma concurrente y limpia. (0,25 puntos)
  *Estado*: **Implementado** con `nginxproxy/nginx-proxy:alpine`.
    - Archivo `docker-compose.proxy.yml` creado.
    - Dominios virtuales: `api-dev.songs.local`, `dev.songs.local`, `api-prod.songs.local`, `prod.songs.local`.

## Instrucciones de Ejecución

### Configuración del Archivo Hosts (Requerido para Proxy Inverso)

Añadir las siguientes líneas al archivo hosts del sistema:
- **Windows**: `C:\Windows\System32\drivers\etc\hosts`
- **Linux/Mac**: `/etc/hosts`

```
127.0.0.1 dev.songs.local
127.0.0.1 api-dev.songs.local
127.0.0.1 prod.songs.local
127.0.0.1 api-prod.songs.local
```

### Iniciar el Proxy Inverso

```bash
docker compose -f docker-compose.proxy.yml up -d
```

### Entorno de Desarrollo

1.  Crear el archivo de entorno:
    ```bash
    cp .env.example .env.dev
    ```
2.  Ejecutar el entorno de desarrollo:
    ```bash
    docker compose --env-file .env.dev -f docker-compose.yml -f docker-compose.dev.yml -p songs-api-dev up --build -d
    ```
3.  Acceder a los servicios:
    - **Frontend Dev**: http://localhost:5173 (acceso directo, recomendado para hot-reload)
    - **API Dev vía Proxy**: http://api-dev.songs.local/api/v1/songs
    - **API Dev directo**: http://localhost:8080/api/v1/songs

### Entorno de Producción

1.  Crear el archivo de entorno:
    ```bash
    cp .env.example .env.prod
    # Editar .env.prod para establecer API_PORT=8081, MONGO_PORT=27018, NODE_ENV=production
    ```
2.  Ejecutar el entorno de producción:
    ```bash
    docker compose --env-file .env.prod -f docker-compose.yml -f docker-compose.prod.yml -p songs-api-prod up --build -d
    ```
3.  Acceder a los servicios:
    - **Frontend Prod vía Proxy**: http://prod.songs.local
    - **API Prod vía Proxy**: http://api-prod.songs.local/api/v1/songs
    - **Frontend Prod directo**: http://localhost:8082
    - **API Prod directo**: http://localhost:8081/api/v1/songs

### Detener los Entornos

```bash
# Detener desarrollo
docker compose -p songs-api-dev down

# Detener producción
docker compose -p songs-api-prod down

# Detener proxy
docker compose -f docker-compose.proxy.yml down
```

## Uso de Logs

Los logs se almacenan en volúmenes Docker para persistencia.

Para consultar los logs de la API en tiempo real:
```bash
docker exec -it <nombre_contenedor_api> tail -f logs/combined.log
```

Ejemplos con los nombres de contenedor actuales:
```bash
# Logs de desarrollo
docker exec -it songs-api-dev-songs-api-1 tail -f logs/combined.log

# Logs de producción
docker exec -it songs-api-prod-songs-api-1 tail -f logs/combined.log
```

